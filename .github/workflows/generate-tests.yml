# =============================================================================
# AI Contract Test Generation - WITH TEST VALIDATION
# =============================================================================
#
# FLOW:
#   1. Generate tests with AI
#   2. Run tests to validate
#   3. If FAIL → Retry with error feedback (max 2 retries)
#   4. Create PR with status (✅ validated OR ⚠️ needs review)
#
# =============================================================================

name: Generate Contract Tests

on:
  workflow_call:
    inputs:
      repository:
        description: 'Repository in owner/repo format'
        required: true
        type: string
      pr_number:
        description: 'Pull Request number'
        required: true
        type: number
      target_repo:
        description: 'Repository where tests should be created'
        required: true
        type: string
      max_retries:
        description: 'Maximum retry attempts if tests fail (default: 2)'
        required: false
        type: number
        default: 2
    secrets:
      GEMINI_API_KEY:
        required: true
      PACTFLOW_TOKEN:
        required: true
      PACTFLOW_BASE_URL:
        required: true
      PAT_TOKEN:
        required: true
      LANGFUSE_PUBLIC_KEY:
        required: false
      LANGFUSE_SECRET_KEY:
        required: false

jobs:
  generate-validate-pr:
    name: Generate, Validate & Create PR
    runs-on: ubuntu-latest
    
    steps:
      # =====================================================================
      # SETUP
      # =====================================================================
      - name: Checkout central repo
        uses: actions/checkout@v4
        with:
          repository: KalpitaG/ai-contract-testing-demo
          token: ${{ secrets.PAT_TOKEN }}
          path: ai-contract-testing
      
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo
          fetch-depth: 0
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: ai-contract-testing/requirements.txt
      
      - name: Set up Node.js 18 (for JS/TS tests)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
        continue-on-error: true
      
      - name: Install Python dependencies
        run: |
          pip install -r ai-contract-testing/requirements.txt
      
      - name: Install target repo dependencies
        working-directory: target-repo
        run: |
          if [ -f "package.json" ]; then
            echo "Installing npm dependencies..."
            npm install
          elif [ -f "go.mod" ]; then
            echo "Downloading Go modules..."
            go mod download
          elif [ -f "requirements.txt" ]; then
            echo "Installing pip dependencies..."
            pip install -r requirements.txt
          fi
        continue-on-error: true
      
      # =====================================================================
      # GENERATE & VALIDATE (with retry loop)
      # =====================================================================
      - name: Generate and Validate Tests
        id: validate
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: gemini-2.0-flash
          PACTFLOW_TOKEN: ${{ secrets.PACTFLOW_TOKEN }}
          PACTFLOW_BASE_URL: ${{ secrets.PACTFLOW_BASE_URL }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_HOST: https://cloud.langfuse.com
          MAX_RETRIES: ${{ inputs.max_retries }}
        run: |
          cd ai-contract-testing
          
          # Run the validation loop
          python -m src.github_ops.workflow_runner \
            --repo "${{ inputs.repository }}" \
            --pr "${{ inputs.pr_number }}" \
            --target-repo "../target-repo" \
            --max-retries "$MAX_RETRIES" \
            --output-json "../validation-result.json"
          
          # Read results
          if [ -f "../validation-result.json" ]; then
            echo "tests_validated=$(jq -r '.tests_pass' ../validation-result.json)" >> $GITHUB_OUTPUT
            echo "attempts=$(jq -r '.attempts' ../validation-result.json)" >> $GITHUB_OUTPUT
            echo "language=$(jq -r '.language' ../validation-result.json)" >> $GITHUB_OUTPUT
            echo "tests_generated=$(jq -r '.has_tests' ../validation-result.json)" >> $GITHUB_OUTPUT
            echo "skip_reason=$(jq -r '.skip_reason // empty' ../validation-result.json)" >> $GITHUB_OUTPUT
          else
            echo "tests_validated=false" >> $GITHUB_OUTPUT
            echo "tests_generated=false" >> $GITHUB_OUTPUT
          fi
      
      # =====================================================================
      # CREATE PR
      # =====================================================================
      - name: Create PR with Tests
        id: create-pr
        if: steps.validate.outputs.tests_generated == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          cd target-repo
          
          # Get PR info
          PR_DATA=$(gh pr view ${{ inputs.pr_number }} --json headRefName --repo ${{ inputs.target_repo }})
          HEAD_BRANCH=$(echo $PR_DATA | jq -r '.headRefName')
          TEST_BRANCH="contract-tests/pr-${{ inputs.pr_number }}"
          
          # Check if tests directory has files
          if [ ! -d "tests/generated" ] || [ -z "$(ls -A tests/generated 2>/dev/null)" ]; then
            echo "No generated tests found"
            echo "pr_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Setup branch
          git fetch origin $HEAD_BRANCH
          git checkout $HEAD_BRANCH
          
          if git ls-remote --heads origin $TEST_BRANCH | grep -q $TEST_BRANCH; then
            git fetch origin $TEST_BRANCH
            git checkout $TEST_BRANCH
            git merge $HEAD_BRANCH --no-edit || true
          else
            git checkout -b $TEST_BRANCH
          fi
          
          # Configure git
          git config user.name "AI Contract Testing Bot"
          git config user.email "ai-contract-testing@users.noreply.github.com"
          
          # Commit
          git add tests/generated/
          
          VALIDATED="${{ steps.validate.outputs.tests_validated }}"
          ATTEMPTS="${{ steps.validate.outputs.attempts }}"
          
          if [ "$VALIDATED" = "true" ]; then
            git commit -m "✅ AI-generated contract tests (validated on attempt $ATTEMPTS)" || echo "No changes"
          else
            git commit -m "⚠️ AI-generated contract tests (validation failed after $ATTEMPTS attempts)" || echo "No changes"
          fi
          
          git push origin $TEST_BRANCH --force
          
          # Create/update PR
          EXISTING_PR=$(gh pr list --head $TEST_BRANCH --json number --jq '.[0].number' --repo ${{ inputs.target_repo }})
          
          if [ "$VALIDATED" = "true" ]; then
            TITLE="✅ Contract Tests for PR #${{ inputs.pr_number }}"
            BODY="## ✅ AI-Generated Contract Tests (VALIDATED)
          
          Tests passed on attempt $ATTEMPTS!
          
          **Status:** Ready to merge
          **Language:** ${{ steps.validate.outputs.language }}
          
          ---
          *Generated by AI Contract Testing*"
          else
            TITLE="⚠️ Contract Tests for PR #${{ inputs.pr_number }} (Needs Review)"
            BODY="## ⚠️ AI-Generated Contract Tests (NEEDS REVIEW)
          
          Tests failed validation after $ATTEMPTS attempts.
          
          **What to do:**
          1. Review the generated code
          2. Fix any issues manually
          3. Or comment \`ai-revise: <feedback>\` on the original PR
          
          ---
          *Generated by AI Contract Testing*"
          fi
          
          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            gh pr edit $EXISTING_PR --title "$TITLE" --body "$BODY" --repo ${{ inputs.target_repo }}
            PR_URL=$(gh pr view $EXISTING_PR --json url --jq '.url' --repo ${{ inputs.target_repo }})
          else
            PR_URL=$(gh pr create --title "$TITLE" --body "$BODY" --base $HEAD_BRANCH --head $TEST_BRANCH --repo ${{ inputs.target_repo }})
          fi
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "pr_created=true" >> $GITHUB_OUTPUT
      
      # =====================================================================
      # COMMENT ON ORIGINAL PR
      # =====================================================================
      - name: Comment on Original PR
        if: steps.validate.outputs.tests_generated == 'true' && steps.create-pr.outputs.pr_created == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          VALIDATED="${{ steps.validate.outputs.tests_validated }}"
          ATTEMPTS="${{ steps.validate.outputs.attempts }}"
          PR_URL="${{ steps.create-pr.outputs.pr_url }}"
          
          if [ "$VALIDATED" = "true" ]; then
            COMMENT="## ✅ Contract Tests Generated & Validated!

          **Test PR:** $PR_URL
          **Validation:** Passed on attempt $ATTEMPTS

          The tests have been automatically validated and are ready for review.

          ---
          *AI Contract Testing*"
          else
            COMMENT="## ⚠️ Contract Tests Generated (Validation Failed)

          **Test PR:** $PR_URL
          **Attempts:** $ATTEMPTS

          The tests were generated but failed validation after $ATTEMPTS attempts. Please review and fix manually.

          ---
          *AI Contract Testing*"
          fi
          
          gh pr comment ${{ inputs.pr_number }} --repo ${{ inputs.repository }} --body "$COMMENT"
      
      - name: Comment on Original PR (Skipped)
        if: steps.validate.outputs.tests_generated == 'false' && steps.validate.outputs.skip_reason != ''
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          COMMENT="## ℹ️ Contract Test Generation Skipped

          **Reason:** ${{ steps.validate.outputs.skip_reason }}

          ---
          *AI Contract Testing*"
          
          gh pr comment ${{ inputs.pr_number }} --repo ${{ inputs.repository }} --body "$COMMENT"
      
      # =====================================================================
      # UPLOAD ARTIFACTS
      # =====================================================================
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-logs
          path: |
            validation-result.json
          retention-days: 7