# =============================================================================
# AI Contract Test Generation - Reusable Workflow
# =============================================================================
# This workflow is called by consumer repos to generate Pact contract tests.
# It lives in the central ai-contract-testing-demo repo.
#
# Usage from consumer repo:
#   uses: KalpitaG/ai-contract-testing-demo/.github/workflows/generate-tests.yml@main
#
# =============================================================================

name: Generate Contract Tests

on:
  workflow_call:
    inputs:
      repository:
        description: 'Repository in owner/repo format'
        required: true
        type: string
      pr_number:
        description: 'Pull Request number'
        required: true
        type: number
      target_repo:
        description: 'Repository where tests should be created (usually same as repository)'
        required: true
        type: string
    secrets:
      GEMINI_API_KEY:
        required: true
      PACTFLOW_TOKEN:
        required: true
      PACTFLOW_BASE_URL:
        required: true
      PAT_TOKEN:
        required: true
        description: 'Personal Access Token with repo scope for creating PRs'
      LANGFUSE_PUBLIC_KEY:
        required: false
      LANGFUSE_SECRET_KEY:
        required: false
      JIRA_BASE_URL:
        required: false
      JIRA_EMAIL:
        required: false
      JIRA_API_TOKEN:
        required: false

jobs:
  generate-tests:
    name: Generate Contract Tests
    runs-on: ubuntu-latest
    
    outputs:
      tests_generated: ${{ steps.run-pipeline.outputs.tests_generated }}
      test_pr_url: ${{ steps.create-pr.outputs.pr_url }}
      skip_reason: ${{ steps.run-pipeline.outputs.skip_reason }}
    
    steps:
      # -----------------------------------------------------------------------
      # Setup
      # -----------------------------------------------------------------------
      - name: Checkout central repo (ai-contract-testing-demo)
        uses: actions/checkout@v4
        with:
          repository: KalpitaG/ai-contract-testing-demo
          token: ${{ secrets.PAT_TOKEN }}
          path: ai-contract-testing
      
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo
          fetch-depth: 0  # Full history for branch creation
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: ai-contract-testing/requirements.txt
      
      - name: Install dependencies
        run: |
          cd ai-contract-testing
          pip install -r requirements.txt
      
      # -----------------------------------------------------------------------
      # Run AI Pipeline
      # -----------------------------------------------------------------------
      - name: Run AI Contract Test Pipeline
        id: run-pipeline
        env:
          # Required
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: gemini-2.0-flash
          PACTFLOW_TOKEN: ${{ secrets.PACTFLOW_TOKEN }}
          PACTFLOW_BASE_URL: ${{ secrets.PACTFLOW_BASE_URL }}
          # Optional - Langfuse
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_HOST: https://cloud.langfuse.com
          # Optional - JIRA
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          # Pipeline config
          TARGET_REPO_PATH: ${{ github.workspace }}/target-repo
        run: |
          cd ai-contract-testing
          
          # Run the pipeline and capture output
          python -m src.pipeline \
            ${{ inputs.repository }} \
            ${{ inputs.pr_number }} \
            --output-dir ../generated-tests \
            2>&1 | tee pipeline-output.log
          
          # Check if tests were generated
          if [ -d "../generated-tests" ] && [ "$(ls -A ../generated-tests 2>/dev/null)" ]; then
            echo "tests_generated=true" >> $GITHUB_OUTPUT
            echo "Tests were generated successfully"
          else
            echo "tests_generated=false" >> $GITHUB_OUTPUT
            # Try to extract skip reason from log
            SKIP_REASON=$(grep -oP 'Skipping: \K.*' pipeline-output.log || echo "No tests generated")
            echo "skip_reason=${SKIP_REASON}" >> $GITHUB_OUTPUT
          fi
      
      # -----------------------------------------------------------------------
      # Create PR with Generated Tests
      # -----------------------------------------------------------------------
      - name: Create PR with Generated Tests
        id: create-pr
        if: steps.run-pipeline.outputs.tests_generated == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          TARGET_REPO: ${{ inputs.target_repo }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          cd target-repo
          
          # Get the PR's head branch
          PR_DATA=$(gh pr view $PR_NUMBER --json headRefName,headRefOid --repo $TARGET_REPO)
          HEAD_BRANCH=$(echo $PR_DATA | jq -r '.headRefName')
          HEAD_SHA=$(echo $PR_DATA | jq -r '.headRefOid')
          
          # Create a new branch for the tests
          TEST_BRANCH="contract-tests/pr-${PR_NUMBER}"
          
          # Check if branch already exists
          if git ls-remote --heads origin $TEST_BRANCH | grep -q $TEST_BRANCH; then
            echo "Branch $TEST_BRANCH already exists, checking it out"
            git fetch origin $TEST_BRANCH
            git checkout $TEST_BRANCH
          else
            echo "Creating new branch $TEST_BRANCH from $HEAD_BRANCH"
            git checkout $HEAD_BRANCH
            git checkout -b $TEST_BRANCH
          fi
          
          # Copy generated tests to appropriate location
          mkdir -p tests/generated
          echo "Looking for generated tests in: ${{ github.workspace }}/generated-tests"
          ls -la ${{ github.workspace }}/generated-tests/ || echo "Directory not found"
          cp -rv ${{ github.workspace }}/generated-tests/* tests/generated/ || echo "Copy failed"
          ls -la tests/generated/ || echo "No files copied"
          
          # Stage all new files
          git add tests/generated/
          
          # Check if there are changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            echo "pr_url=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Configure git
          git config user.name "AI Contract Testing Bot"
          git config user.email "ai-contract-testing@users.noreply.github.com"
          
          # Commit the tests
          git add tests/generated/
          git commit -m "AI-generated contract tests for PR #${PR_NUMBER}
          
          These Pact contract tests were automatically generated by the AI Contract Testing workflow.
          
          Please review the generated tests and merge if they look correct.
          
          Related PR: #${PR_NUMBER}"
          
          # Push the branch
          git push origin $TEST_BRANCH --force
          
          # Create or update PR
          EXISTING_PR=$(gh pr list --head $TEST_BRANCH --json number --jq '.[0].number' --repo $TARGET_REPO)
          
          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "PR already exists: #$EXISTING_PR"
            PR_URL=$(gh pr view $EXISTING_PR --json url --jq '.url' --repo $TARGET_REPO)
          else
            PR_URL=$(gh pr create \
              --title "Contract Tests for PR #${PR_NUMBER}" \
              --body "## AI-Generated Contract Tests
          
          This PR contains Pact contract tests automatically generated for PR #${PR_NUMBER}.
          
          ### What to do:
          1. Review the generated test code
          2. If tests look correct, approve and merge this PR into your feature branch
          3. If changes are needed, comment \`ai-revise: <your feedback>\` on the original PR
          
          ### Generated by
          AI Contract Testing Workflow powered by Gemini
          
          ---
          *This is an automated PR. Please review carefully before merging.*" \
              --base $HEAD_BRANCH \
              --head $TEST_BRANCH \
              --repo $TARGET_REPO)
          fi
          
          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          echo "Created/Updated PR: $PR_URL"
      
      # -----------------------------------------------------------------------
      # Comment on Original PR
      # -----------------------------------------------------------------------
      - name: Comment on Original PR (Success)
        if: steps.run-pipeline.outputs.tests_generated == 'true' && steps.create-pr.outputs.pr_url != ''
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          gh pr comment ${{ inputs.pr_number }} \
            --repo ${{ inputs.repository }} \
            --body "## ✅ Contract Tests Generated

          I've analyzed your PR and generated Pact contract tests.

          **Test PR:** ${{ steps.create-pr.outputs.pr_url }}

          ### Next Steps:
          1. Review the generated tests in the linked PR
          2. If the tests look good, merge the test PR into your feature branch
          3. If you need changes, comment here with: \`ai-revise: <your feedback>\`

          ---
          *Generated by AI Contract Testing Workflow*"
      
      - name: Comment on Original PR (Skipped)
        if: steps.run-pipeline.outputs.tests_generated == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          gh pr comment ${{ inputs.pr_number }} \
            --repo ${{ inputs.repository }} \
            --body "## ℹ️ Contract Test Generation Skipped

          I analyzed your PR but did not generate contract tests.

          **Reason:** ${{ steps.run-pipeline.outputs.skip_reason }}

          This usually means:
          - No API-related changes were detected in the PR
          - No OpenAPI specification was found
          - The changes don't require contract testing

          If you believe this is incorrect, please check:
          1. Your PR contains API endpoint changes
          2. An OpenAPI spec exists in \`oas/\`, \`api/\`, or \`docs/\` folder

          ---
          *Generated by AI Contract Testing Workflow*"
      
      # -----------------------------------------------------------------------
      # Upload Artifacts (for debugging)
      # -----------------------------------------------------------------------
      - name: Upload Pipeline Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs
          path: |
            ai-contract-testing/pipeline-output.log
          retention-days: 7
      
      - name: Upload Generated Tests
        if: steps.run-pipeline.outputs.tests_generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: generated-tests
          path: generated-tests/
          retention-days: 30
